---
layout:     post   				    # 使用的布局（不需要改）
title:      一些网络问题梳理  		# 标题 
subtitle:  	包括证书密钥泄露和DNS的anycast         #副标题
date:       2020-05-06		# 时间
author:     Haiming 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - Programming
    - Network
---

今日发现了在证书链传递过程之中和DNS相关的一些问题没太搞清楚，再来总结一下，把问题摸清。

# 1. 证书私钥泄露了怎么办？

参考：https://www.anquanke.com/post/id/183339

假设证书链之中的某一个环节，其私钥被泄露出去了，那么该怎么办？

这种情况就需要吊销证书了。那么如果证书的状态是已吊销，怎么能够让其他的终端知道这个证书已经被吊销呢？

## .1 远古时代——Certificate Revocation Lists(CRL)

CA会定期发放这个CRL——撤销证书列表。这个CRL分布在公共可用的存储库之中，浏览器哦可以在验证证书的时候查询并且获得CA的最新CRL。

其缺陷为：

1. 受限于CRL发布期，假设有一个CA的发布期是一个月，那么就意味着这个月之内，黑客可以为所欲为。
2. 文件平均大小是1M，如果在网络请求之前需要下载这个文件，那代价有些太大了。

## 1.2 Online Certificate Status Protocol(OCSP)

这种情况修改了之前的下载文件本地校验的过程，而是提供一个接口，浏览器通过线上OCSP服务器之中请求证书的撤销状态，OCSP Server再给出响应。这种方法可以避免CRL更新延迟问题。

### 1.2.1 OCSP的缺点：

1. 浏览器每次发送HTTPS信息之前，都得去连接CA OCSP Server来进行验证，那么如果和OCSP的连接不稳定，就会花费很长时间。
2. 如果每次使用HTTPS的时候都需要进行验证，那么OCSP Server本身其实也是一个单点，单点就会有瓶颈。
3. 在浏览器发送HTTPS证书序号到CA OCSP Server的时候，也暴露了用户的隐私，将用户访问的网址透露给了CA OCSP Server。

### 1.2.2 OCSP机制衍生的问题

如果浏览器检查HTTPS的吊销状态的时候，得不到OCSP Server 的响应，该如何选择？

1. 拒绝该证书信息：hard-fail,致命的单点故障
2. 信任该证书：soft-fail，认为其没有吊销，会有安全问题

### 1.2.3 OCSP Staping

由于之前的CRL都是由浏览器发出请求，不管是去获取CRL file也好，还是去访问对应的服务器网关也好，那么就容易收到客户端网络质量的干扰。

OCSP Staping 的方案解决了 CRL，OCSP之中的缺点，其将获取OCSP Server证书吊销情况的过程交给Web服务器去做。那么网站的服务器进行查询并且将其结果保存。而且OCSP 的响应结果也是CA RSA私钥签名的，所以不必担心伪造。

同样的，这种方式可以避免用户泄露的问题。

### 1.2.4 OCSP Must-Staple

目前支持这个协议的CA是Let's Encrypt。

如果收到的证书之中的标记是OSCP Must-staple,但是没有收到对应的 OSCP Stapling的话，就会拒绝这个证书。意思就是必须携着OCSP Stapling的信息来进行一起投递，只投递一个的话直接拒绝。

# 2. DNS anycast使用场景