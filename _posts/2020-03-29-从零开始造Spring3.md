---
layout:     post   				    # 使用的布局（不需要改）
title:      Build a Spring from Zero(2)  		# 标题 
subtitle:   Import Exception, meet Single Responsibility Principle      #副标题
date:       2020-03-29		# 时间
author:     Haiming 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - Programming
    - Java
    - Spring
---

# 1. Refactor code: import Exception and retest

Last article we said that the way only use try catch is not user-friendly. So toady we put them together and build a hierarchy tree like this:

![1585454213803](/img/1585454213803.png)

To test this tree, I change the XML file to this one:

```java
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd">
  
  <bean id="petStore"
        class="org.litespring.service.v1.PetStoreService" >   
  </bean> 
 <bean id="invalidBean"
        class="xxx.xxxxx" >   
  </bean> 
</beans>


```

Can see I add an `invalidBean`, which is not a standard format of class name. 

**BeanCreationException**

Method `getBean` after refactor is this format:

```java
	public Object getBean(String beanID) {
		BeanDefinition bd = this.getBeanDefinition(beanID);
		if(bd == null){
			throw new BeanCreationException("Bean Definition does not exist");
		}
		ClassLoader cl = ClassUtils.getDefaultClassLoader();
		String beanClassName = bd.getBeanClassName();
		try {
			Class<?> clz = cl.loadClass(beanClassName);
			return clz.newInstance();
		} catch (Exception e) {			
			throw new BeanCreationException("create bean for "+ beanClassName +" failed",e);
		} 
	}
```

Can see here if the `BeanDefination` is null, we throw `BeanCreationException`. Here the Exception is from `classLoader`, when we use the `ClassLoader` to generate the class with `xxx.xxxxx`, it will throw an` java.lang.ClassNotFoundException: xxx.xxxxx`,so from here we throw a `BeanCreationException`, then we meet our need.

```java
public Object getBean(String beanID) {
		BeanDefinition bd = this.getBeanDefinition(beanID);
		if(bd == null){
			throw new BeanCreationException("Bean Definition does not exist");
		}
		ClassLoader cl = ClassUtils.getDefaultClassLoader();
		String beanClassName = bd.getBeanClassName();
		try {
			Class<?> clz = cl.loadClass(beanClassName);//Here will throw ClassNotFoundException
			return clz.newInstance();
		} catch (Exception e) {			
			throw new BeanCreationException("create bean for "+ beanClassName +" failed",e);
		} 
	}
```

**BeanDefinitionStoreException**

```java
	private void loadBeanDefinition(String configFile) {
		InputStream is = null;
		try{
			ClassLoader cl = ClassUtils.getDefaultClassLoader();
			is = cl.getResourceAsStream(configFile);
			
			SAXReader reader = new SAXReader();
			Document doc = reader.read(is);
			
			Element root = doc.getRootElement(); //<beans>
			Iterator<Element> iter = root.elementIterator();
			while(iter.hasNext()){
				Element ele = (Element)iter.next();
				String id = ele.attributeValue(ID_ATTRIBUTE);
				String beanClassName = ele.attributeValue(CLASS_ATTRIBUTE);
				BeanDefinition bd = new GenericBeanDefinition(id,beanClassName);
				this.beanDefinitionMap.put(id, bd);
			}
		} catch (DocumentException e) {		
			throw new BeanDefinitionStoreException("IOException parsing XML document from " + configFile,e);// Here will throw BeanDefinitionStoreException

		}finally{
			if(is != null){
				try {
					is.close();
				} catch (IOException e) {					
					e.printStackTrace();
				}
			}
		}
		
		
	}
```

# 2. Refactor to meet Single Responsibility Principle for XML file processing

 Single Responsibility Principle: For one class. there should be only one reason to trigger it change.

Previously, the part of XML file processing is in `DefaultBeanFactory`, this class has all functions like read XML file, produce `BeanDefination`,generate Bean from `BeanDefination` by `classLoader`.  Now we want 

