---
layout:     post   				    # 使用的布局（不需要改）
title:      高性能，高可用网站架构研究				# 标题 
subtitle:   对高性能网站的一点梳理 #副标题
date:       2019-10-01 				# 时间
author:     Haiming 						# 作者
header-img: img/post-bg-2015.jpg 	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - 编程
    - 架构
    - 后端
---

看到一篇文章，[手把手教你构建一个高性能、高可用的大型分布式网站](https://www.toutiao.com/a6573634116791566851/)，其中将 **大型分布式网站** 的架构做了一个梳理，那就自己看着学习一下。

# 1. 大型网站的特点与架构目标

下面是一般的大型网站的特点：

- 用户多，分布广泛
- 大流量，高并发
- 海量数据，服务 **高可用**
- 安全环境恶劣，易受网络攻击
- 功能较多，迭代较快，发布比较频繁
- 从小到大，采取渐进发展的发展方式

大型网站架构目标图为：

![手把手教你构建一个高性能、高可用的大型分布式网站](../img1/1530543439088d2ef288fcd.jpg)

下面是针对每一个目标的解释：

- 高性能：提供快速的访问体验，且互联网企业一般对于用户响应时间有一定的要求
- 高可用： 网站服务稳定，可以一直正常访问
- 可伸缩： 通过硬件的增加和减少，**提高/降低** 处理能力

- 扩展性：上一条是针对整个系统而言，那么这一条主要是针对功能而言。指的组要是可以方便的通过 **新增/移除** 方式，来对于 **功能/模块** 进行增加或者删除。对应的是上面 ”功能较多，迭代较快“。
- 安全性： 提供网站的安全访问和数据加密，安全存储等等策略
- 敏捷性：随需求应变，快速响应

# 2. 大型网站的架构模式

那么可以满足上面要求的大型网站的架构模式一般如下：

![手把手教你构建一个高性能、高可用的大型分布式网站](../img1/1530543441077f6840d6e5b.jpg)

下面是针对大型网站的架构模式的分点解释：

- 分层：一般而言，都会将业务分层。业务一般可以分为 **应用层**，**服务层**， **数据层**， **管理层** 和 **分析层**。分层结构可以更好维护
- 分割： 一般按照 **业务/模块/功能** 特点进行划分，比如应用层这一层分为 首页，用户中心 等等
- 分布式： 将应用分开部署（比如多台物理机或者是虚拟机），通过远程调用协调工作。分布式可以降低因为单点故障整个服务宕机的情况。
- 集群： 一个 **应用/模块/功能** 部署多份，通过负载均衡共同提供对外访问。可以降低因为单点故障整个服务宕机的情况。

- 缓存：将数据放在距离应用或者用户最近的位置，加快数据的访问速度。CDN 缓存就是这样的一种，将内容放在离用户更近的地方。
- 异步：将同步的操作异步化。在客户端发出请求之后，不是等待服务端响应之后再进行下一步操作，而是等服务端处理完毕之后，使用 **通知** 或者 **轮询** 的方式告知请求方，一般指的是 **请求——响应——通知** 模式。
- 冗余：增加副本，提高可用性，安全性和性能。
- 安全：下面这个对于安全的定义非常有趣：对 **已知问题** 有有效的解决方案，对 **未知/潜在** 问题建立 **发现和防御** 机制。
- 自动化：将重复的，不需要人工参与的事情，通过工具的方式，使用机器完成。包括在 CI/CD pipeline 之中，要想业务多次快速迭代，要求就是自动化水平极高
- 敏捷性： 积极接受需求变更，，快速响应业务发展需求。程序跟着功能走。

# 3. ”大型网站架构目标”分点梳理

再次回到我们上面提到的 ”大型网站架构目标“，我们针对那六点要求进行分点的梳理：

## 3.1 高性能架构

高性能架构的主要目的是为用户提供较为快速的网页访问体验。主要参数有：

- 较短的响应时间
- 较大的并发处理能力
- 较高的吞吐量
- 稳定的性能参数

优化方向可以分为：

- 前端优化：网站业务逻辑 **之前** 的部分

- 浏览器优化：

  - 减少 HTTP 请求数

  - 使用浏览器缓存

  - 启用压缩

  - CSS JS 位置（CSS 和 JS 的加载和执行会阻塞浏览器渲染）

  - JS 异步

  - 减少 Cookie 传输

  - CDN 加速

  - 反向代理

    反向代理服务器位于机房一侧，代理网站 Web 服务器接收 HTTP 请求。不仅具有保护网站安全的作用，也可以配置缓存功能加速 Web 请求，可以将 静态内容 等等缓存在反向代理服务器上。

- 应用层优化：处理网站业务的服务器

  - 使用缓存，异步，集群。

- 代码优化：

  - 合理的架构，多线程，资源复用（对象池，线程池等等）

  - 良好的数据结构

  - JVM 调优

  - 单例

    单例模式创建的对象可以确保 **系统之中只产生一个示例**， 主要好处在于省略频繁使用的对象所创建需要花费的时间，和由于 new 操作次数减少从而降低系统内存的使用频率，降低 GC 压力和缩短 GC 停顿时间

  - Cache 层面的优化（CPU内部不同 level 的 Cache 使用）

- 存储优化：
  - 缓存，固态硬盘，光纤传输
  - 优化读写，磁盘冗余
  - 分布式存储(HDFS)
  - NoSQL

## 3.2 高可用架构

大型网站要保证在任何时候都可以正常访问。因为大型网站的复杂性很高，分布式，廉价服务器，开源数据库，开源操作系统等等特点，要保证高可用是很困难的。

想要提高可用性，第一点就是从架构级别考虑。

不同层级使用的策略不同，一般采用 **冗余备份** 和 **失效转移** 解决高可用问题。

- 应用层：一般设计为无状态的。对于每次请求，使用哪一台服务器处理是没有影响的。一般采用 **负载均衡** 技术（需要解决 Session 在不同服务器之间的同步问题）来实现高可用。

- 服务层：

  - 负载均衡
  - 分级管理
  - 快速失败（超时设置）
  - 异步调用
  - 服务降级

- 数据层：

  - 冗余备份（冷备份，热备份[同步备份，异步备份]，温备份）

  - 失效转移（确认，转移，恢复）

    数据高可用方面的著名理论是 CAP 理论，在之前的博文之中对 CAP 和 数据一致性 有说明，就不赘述了）

## 3.3 可伸缩架构

伸缩性是指在不改变原有架构设计的基础上，通过增加/减少硬件的方式，提高/降低 系统的处理能力。

- 应用层：
  - 对应用进行垂直或者水平切分，然后针对单一功能进行负载均衡（DNS，HTTP，IP，链路层）
  - 服务层：与应用层类似
  - 数据层：
    - 分库
    - 分表
    - NoSQL
    - 常用算法 Hash
    - 一致性 Hash

## 3.4 可扩展架构

可以方便的进行功能模块的新增/移除，提供代码/模块级别良好的可扩展性。

- 模块化，组件化：高内聚，低耦合
  - 高内聚：每个模块尽可能独立的完成自己的功能，不依赖模块外部的代码
  - 低耦合： 降低模块与模块之间接口的复杂程度
- 稳定接口：定义稳定的接口。在接口不变的情况下，内部结构可以变化
- 设计模式
- 消息队列：之前博文之中有讲到过，模块化的系统，通过消息队列进行狡猾，可以做到解耦。但是消息队列的引入也增加了系统的复杂性。
- 分布式服务：公用模块 服务化，提供给其他系统使用。提高可重用性，扩展性。

## 3.5 安全架构

对上面所提到的定义进行进一步的扩展梳理：

首先是要提高安全意识（例如不要把密码贴在显示器前面……）

安全问题包括基础设置安全，应用系统安全，数据保密安全等等。

- 基础设施安全：硬件采购，操作系统等等的安全。

- 应用系统安全：在程序开发的时候，对已知常用问题，使用正确的方式，在代码层面解决掉

  - 防止跨站脚本攻击（XSS）

    这篇美团的文章写的很好：https://tech.meituan.com/2018/09/27/fe-security.html

    XSS 攻击主要是恶意代码未经过过滤，和网站正常的代码混合在一起，Browser 无法分辨哪些脚本是可信的，导致恶意脚本被执行。

  - 注入攻击：指的是 SQL 注入攻击。



